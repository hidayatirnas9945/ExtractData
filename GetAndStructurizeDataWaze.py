import requests
import threading
import pandas as pd
from sqlalchemy import create_engine
import json
import datetime

PolygonKabupaten={
    'KAB. SUKABUMI':{
        'polygon':'106.38473510742186,-6.987769928155617;106.42181396484375,-6.99867452414757;106.47674560546875,-6.987769928155617;106.48910522460938,-7.038201546082072;106.42318725585936,-7.1349603521108085;106.35726928710938,-7.184013359028494;106.33804321289061,-7.329778414392971;106.435546875,-7.385619727854383;106.62094116210938,-7.452347650524256;106.7926025390625,-7.459156052246987;106.82693481445312,-7.421027640985758;106.84890747070312,-7.391067284066362;106.95465087890625,-7.358380940700133;106.99310302734374,-7.279379022306316;107.00546264648438,-7.184013359028494;106.96563720703125,-7.0954416047696025;106.98486328124999,-7.058645237673327;107.06451416015625,-7.066822461559344;107.07138061523436,-6.989133016574015;107.07962036132812,-6.905977376721612;107.02331542968749,-6.796898667064052;106.97250366210938,-6.754623990449012;106.83517456054688,-6.719164960283201;106.76376342773438,-6.69461488552154;106.62506103515625,-6.706890077528025;106.5399169921875,-6.695978810998866;106.4520263671875,-6.766897665279352;106.37786865234375,-6.862348888576029;106.38473510742186,-6.987769928155617',
        'kodekab':'32.02'
    },
    'KAB. CIANJUR':{
        'polygon':'106.76376342773438,-7.442815710341247;107.03842163085938,-7.476857400769451;107.43667602539061,-7.523149837982484;107.46139526367188,-7.470049274643692;107.49160766601561,-7.393791036980667;107.51632690429688,-7.317519626139975;107.4627685546875,-7.234423433691026;107.38723754882812,-7.224886823136359;107.31033325195312,-7.196275785130191;107.34329223632811,-7.148586716248072;107.33230590820312,-7.091353264512176;107.28286743164062,-7.066822461559344;107.22244262695312,-7.017756953860871;107.22656249999999,-6.985043739395521;107.3529052734375,-6.903250713826217;107.3583984375,-6.862348888576029;107.34054565429688,-6.818716401984169;107.30072021484375,-6.7614427371695;107.29522705078125,-6.6891591455092305;107.29248046875,-6.627777883529181;107.23342895507812,-6.58685279251426;107.1441650390625,-6.608679929122795;107.02743530273438,-6.623685526922455;106.973876953125,-6.700070564556916;106.9573974609375,-6.799625938147785;107.017822265625,-6.948238638117006;106.96151733398436,-6.990496101016948;106.92993164062499,-7.159487514966097;106.94366455078125,-7.279379022306316;106.91482543945311,-7.312071167657926;106.84890747070312,-7.332502543763999;106.78436279296875,-7.358380940700133;106.75140380859374,-7.393791036980667;106.76376342773438,-7.442815710341247',
        'kodekab':'32.03'
    },
    'KAB. GARUT':{
        'polygon':'107.41195678710938,-7.514980942395872;107.47512817382812,-7.539487167568601;107.57537841796875,-7.593940472759066;107.64129638671875,-7.667441482726056;107.77450561523438,-7.6973827067235465;107.85964965820312,-7.759980241585301;107.92556762695312,-7.7422905753200135;107.95028686523438,-7.685134279311517;107.94754028320312,-7.651109017589451;107.9681396484375,-7.550378378185986;107.98187255859375,-7.452347650524256;107.94342041015624,-7.369276656587004;107.94754028320312,-7.318881730366743;108.00521850585938,-7.2902766693783825;108.08212280273438,-7.239872834988181;108.10821533203124,-7.147224098111096;108.18923950195312,-7.106343667874101;108.13705444335938,-7.006852803970465;108.0889892578125,-6.953691427897033;107.99972534179688,-6.930516634816176;107.90084838867188,-6.920973741554143;107.8692626953125,-7.028660848301275;107.79510498046875,-7.070911019259513;107.71133422851562,-7.132235030578753;107.67150878906249,-7.261669781279368;107.57125854492188,-7.199000723728755;107.46963500976562,-7.226249208399038;107.43667602539061,-7.333864602200016;107.40371704101562,-7.400600345742086;107.41195678710938,-7.514980942395872',
        'kodekab':'32.05'
    },
    'KAB. TASIKMALAYA':{
        'polygon':'107.89260864257812,-7.7504551290452115;108.31832885742186,-7.844336075064974;108.35128784179688,-7.822568458247752;108.34579467773438,-7.746372871965306;108.37326049804686,-7.644303639113597;108.38424682617188,-7.55990796239314;108.44329833984374,-7.527234228107989;108.46527099609375,-7.465964348046472;108.446044921875,-7.393791036980667;108.39797973632812,-7.348846969785414;108.31146240234375,-7.318881730366743;108.27301025390625,-7.328416343459472;108.23318481445312,-7.406047717076258;108.22219848632812,-7.389705401310166;108.19473266601562,-7.347484957231748;108.20297241210938,-7.298449730693066;108.23455810546875,-7.164937816661006;108.25927734375,-7.109069143257817;108.21807861328125,-7.069548170712799;108.15216064453125,-7.012304910822604;108.10684204101562,-7.045016210142384;108.0780029296875,-7.107706407586725;108.04367065429688,-7.181288330506884;107.96676635742186,-7.246684494014693;107.9022216796875,-7.307984780163877;107.88711547851562,-7.350208978163419;107.89672851562499,-7.385619727854383;107.92282104492188,-7.450985957477231;107.9296875,-7.532680021759207;107.89260864257812,-7.596662957328543;107.89810180664062,-7.674246491629;107.89260864257812,-7.7504551290452115',
        'kodekab':'32.06'
    },
    'KAB. KUNINGAN':{
        'polygon':'108.59367370605469,-6.892343905203222;108.54148864746094,-6.85825851242774;108.50852966308594,-6.779171028142861;108.4185791015625,-6.770988820924254;108.38630676269531,-6.7893985918205635;108.39523315429688,-6.852122882357877;108.36021423339844,-6.929153376172381;108.37394714355469,-7.052512224914607;108.45085144042967,-7.126102997833902;108.48861694335938,-7.162212673957279;108.56071472167969,-7.198319490613502;108.60054016113281,-7.166981662996504;108.63555908203125,-7.161531385736193;108.72550964355469,-7.141773584935546;108.78250122070312,-7.109069143257817;108.79486083984375,-7.049786415392133;108.79966735839844,-7.00003758074107;108.7481689453125,-6.972775693390861;108.72482299804688,-6.942785785094588;108.68362426757812,-6.910748998967528;108.65066528320312,-6.897115664880333;108.59367370605469,-6.892343905203222',
        'kodekab':'32.08'
    },
    'KAB. CIREBON':{
        'polygon':'108.7921142578125,-6.734167173980427;108.7371826171875,-6.779171028142861;108.665771484375,-6.7416681069628615;108.61083984375,-6.746441367521438;108.5943603515625,-6.738258606353293;108.57444763183594,-6.6891591455092305;108.57856750488281,-6.629824049097623;108.55316162109375,-6.50294582512445;108.52569580078125,-6.5008991379959555;108.46733093261719,-6.530916379570446;108.4625244140625,-6.512496921492705;108.41720581054688,-6.500216907101655;108.369140625,-6.530916379570446;108.34373474121094,-6.555474602201876;108.31695556640625,-6.5841243328595835;108.31764221191405,-6.632552256643165;108.34098815917967,-6.687113227293964;108.34648132324219,-6.742350004207154;108.38356018066406,-6.785307592413553;108.44879150390625,-6.796216846875261;108.49479675292969,-6.806444048123669;108.49754333496092,-6.835760816356314;108.52020263671874,-6.875301514437493;108.59916687011717,-6.911430655357397;108.63212585449219,-6.934606387087914;108.67950439453125,-6.944830612386125;108.69667053222656,-6.957099389372643;108.709716796875,-7.003445204803988;108.75091552734375,-7.002763681982734;108.77220153808594,-6.977546638376867;108.76602172851562,-6.927108480815676;108.77357482910156,-6.908022363579669;108.83674621582031,-6.852122882357877;108.84979248046875,-6.7723525317661215;108.81546020507812,-6.726666125044956;108.7921142578125,-6.734167173980427',
        'kodekab':'32.09'
    },
    'KAB. MAJALENGKA':{
        'polygon':'108.07525634765625,-6.551381648974552;108.0120849609375,-6.597766481039653;108.03817749023438,-6.661879532501472;108.11233520507812,-6.736894799396768;108.17413330078125,-6.911430655357397;108.10684204101562,-7.0163939490865195;108.12606811523438,-7.076362373228534;108.24691772460938,-7.091353264512176;108.35128784179688,-7.087264887963057;108.40347290039061,-7.058645237673327;108.41445922851562,-6.942785785094588;108.42681884765624,-6.82826134882511;108.38424682617188,-6.6918870231344485;108.34167480468749,-6.61277241008524;108.204345703125,-6.543195641804587;108.16314697265625,-6.573210344330787;108.12057495117188,-6.510450273276745;108.07525634765625,-6.551381648974552',
        'kodekab':'32.10'
    },
    'KAB. SUMEDANG':{
        'polygon':'107.83424377441405,-6.618228998650672;107.81639099121094,-6.656423427652227;107.79304504394531,-6.681657403518045;107.83149719238281,-6.7307576206492215;107.81913757324217,-6.7723525317661215;107.79991149902344,-6.783262079675447;107.77381896972656,-6.795535025719518;107.72850036621094,-6.807807658501318;107.73330688476561,-6.86643922958172;107.75253295898438,-6.913475618628448;107.742919921875,-6.946193825642211;107.77931213378906,-6.964596817535289;107.82737731933592,-6.984362189722027;107.91732788085938,-6.965278395972943;108.00933837890625,-6.997311463573288;108.05809020996094,-7.01571244520281;108.07456970214844,-7.0088973515151185;108.116455078125,-7.0470605898326415;108.16108703613281,-7.035475652433024;108.19610595703125,-6.968686273301305;108.22151184082031,-6.925063576592017;108.22357177734375,-6.887572097488081;108.19816589355469,-6.836442580298929;108.17619323730469,-6.805762241482235;108.17001342773436,-6.776443641161725;108.1768798828125,-6.73757670335441;108.15902709960938,-6.701434474782401;108.10272216796875,-6.6611975227129845;108.03955078125,-6.6270958264527415;108.02169799804686,-6.64210086405707;107.99423217773438,-6.648239156702318;107.95646667480469,-6.613454486951549;107.93037414550781,-6.5895812371657;107.90702819824219,-6.581395858207802;107.808837890625,-6.550017323769185;107.83424377441405,-6.618228998650672',
        'kodekab':'32.11'
    },
    'KAB. SUBANG':{
        'polygon':'107.633056640625,-6.174688979748151;107.59735107421875,-6.192437893691237;107.5341796875,-6.316663493894265;107.51220703125,-6.4449531392614885;107.5396728515625,-6.562296116238848;107.567138671875,-6.728711877155958;107.633056640625,-6.806444048123669;107.7923583984375,-6.832351982057977;107.85552978515625,-6.775079941885614;107.8472900390625,-6.682339384819373;107.86788940429688,-6.615500711901609;107.92144775390625,-6.545924325774906;107.91320800781249,-6.442223907855765;107.95166015624999,-6.378082757182601;107.918701171875,-6.222473157416403;107.89810180664062,-6.178784935825187;107.83218383789062,-6.163766275391104;107.75665283203124,-6.167862315899159;107.67013549804688,-6.20745573961856;107.633056640625,-6.174688979748151',
        'kodekab':'32.13'
    },
    'KAB. PURWAKARTA':{
        'polygon':'107.27325439453124,-6.522047836110122;107.259521484375,-6.537056048382331;107.21763610839844,-6.562978262505649;107.215576171875,-6.607997845669201;107.24716186523438,-6.653013331326955;107.23411560058592,-6.6932509562331335;107.26226806640625,-6.717119167990038;107.3309326171875,-6.726666125044956;107.33985900878906,-6.708935912811347;107.39616394042969,-6.706890077528025;107.42294311523438,-6.714391431550202;107.48199462890625,-6.747805147613853;107.52731323242188,-6.779171028142861;107.58293151855469,-6.784625755799487;107.58773803710938,-6.749168923865482;107.60490417480469,-6.724620364318773;107.60696411132812,-6.67620151888108;107.60215759277344,-6.632552256643165;107.60009765625,-6.596402283115148;107.57057189941406,-6.556838912478826;107.58087158203125,-6.522047836110122;107.56439208984375,-6.475655979210867;107.54310607910156,-6.43335380443904;107.52937316894531,-6.410154340898689;107.50328063964844,-6.401966042769094;107.46345520019531,-6.4128837444015545;107.42637634277344,-6.434718445817623;107.37762451171875,-6.462010502585489;107.35565185546875,-6.47633824336597;107.31994628906249,-6.479749550305974;107.27531433105469,-6.4920300642018525;107.27325439453124,-6.522047836110122',
        'kodekab':'32.14'
    },
    'KAB. KARAWANG':{
        'polygon':'107.07962036132812,-5.922044619883305;107.05490112304686,-5.972582896218063;107.07687377929688,-6.028579321579229;107.13180541992188,-6.0818388517766335;107.24029541015625,-6.143285598909234;107.2320556640625,-6.219742749707098;107.18811035156249,-6.36579949099102;107.14691162109375,-6.4613282190854;107.15377807617188,-6.555474602201876;107.24166870117186,-6.615500711901609;107.325439453125,-6.521365633956191;107.36251831054688,-6.518636816056048;107.43804931640625,-6.472244644605088;107.5177001953125,-6.44358852539394;107.58773803710938,-6.368529131109202;107.611083984375,-6.287998672327658;107.63442993164062,-6.253871824860197;107.65914916992188,-6.217012327817175;107.61932373046875,-6.170592991992243;107.52044677734375,-6.148747189793983;107.47650146484374,-6.1391893689693795;107.44491577148436,-6.087301070237453;107.41744995117188,-6.029945016071819;107.33505249023438,-5.953460851496156;107.26226806640625,-5.9479972878126475;107.16339111328125,-5.9616560951375215;107.13180541992188,-5.954826733929924;107.07962036132812,-5.922044619883305',
        'kodekab':'32.15'
    },
    'KAB. BANDUNG BARAT':{
        'polygon':'107.29591369628906,-6.725984205760005;107.28355407714844,-6.751896464843375;107.27256774902344,-6.768261387680106;107.29385375976562,-6.795535025719518;107.303466796875,-6.81939819021009;107.31719970703125,-6.867802668770593;107.30003356933594,-6.887572097488081;107.215576171875,-6.930516634816176;107.17437744140625,-6.963233657688719;107.17369079589844,-7.000719107544798;107.17300415039062,-7.053875123660053;107.19841003417969,-7.0743181230326515;107.24166870117186,-7.069548170712799;107.27874755859375,-7.103618176327366;107.33779907226562,-7.124058968682588;107.38998413085936,-7.130872363729571;107.4188232421875,-7.093397439178638;107.46139526367188,-7.072273863785203;107.47650146484374,-7.050467869276467;107.49092102050781,-7.012304910822604;107.51152038574219,-6.994585330485468;107.53143310546875,-6.963915238107172;107.54241943359375,-6.933924764174389;107.52799987792969,-6.897115664880333;107.53349304199219,-6.8616671616578815;107.54653930664061,-6.8787100415377065;107.59391784667969,-6.8787100415377065;107.62687683105469,-6.875301514437493;107.65434265136719,-6.848714164864813;107.6824951171875,-6.851441140808389;107.72369384765625,-6.8398513854216425;107.73536682128906,-6.816671031486219;107.72712707519531,-6.790080421674615;107.70378112792969,-6.782580240165652;107.67906188964842,-6.7703069640581335;107.62138366699219,-6.754623990449012;107.60971069335938,-6.736894799396768;107.58018493652344,-6.717801099710462;107.56095886230469,-6.736894799396768;107.53555297851562,-6.745077583589011;107.49366760253906,-6.717801099710462;107.46208190917969,-6.698024692067479;107.42156982421874,-6.681657403518045;107.38998413085936,-6.685067300513248;107.33779907226562,-6.689841116343772;107.29591369628906,-6.725984205760005',
        'kodekab':'32.17'
    },
    'KAB. PANGANDARAN':{
        'polygon':'108.79348754882811,-7.6973827067235465;108.80859375,-7.6633584251489575;108.77426147460938,-7.636817597487214;108.75572204589844,-7.604149700916396;108.73992919921875,-7.503408077343565;108.71795654296875,-7.460517719883772;108.69598388671875,-7.450985957477231;108.6609649658203,-7.44758170634459;108.6273193359375,-7.465283523235766;108.643798828125,-7.5170231807031;108.62457275390625,-7.533360741154142;108.56483459472656,-7.544932807153508;108.54423522949217,-7.528595682934751;108.51882934570312,-7.518384667571774;108.47763061523438,-7.5170231807031;108.43917846679688,-7.5020465435569506;108.42201232910156,-7.484346216879048;108.38905334472656,-7.46324104244352;108.35746765136717,-7.479580621497736;108.31489562988281,-7.5068118931644365;108.31901550292969,-7.555823880617691;108.33961486816406,-7.583731002068334;108.34510803222656,-7.639539809623023;108.34922790527342,-7.6585948084938265;108.32038879394531,-7.670163499349835;108.31146240234375,-7.694660864529159;108.31352233886719,-7.738888631240038;108.314208984375,-7.77971014512853;108.32794189453125,-7.819847426192575;108.36021423339844,-7.838894277548979;108.45703125,-7.827330221621837;108.50303649902344,-7.802160285513333;108.5126495361328,-7.771546159551934;108.50578308105467,-7.730723853474203;108.52157592773438,-7.710311218385815;108.60671997070311,-7.693299936880303;108.62113952636719,-7.704187235738332;108.63418579101562,-7.719837237448388;108.66233825683594,-7.73956902225241;108.68087768554688,-7.738888631240038;108.69117736816406,-7.708950341008945;108.68019104003906,-7.695341326715805;108.71040344238281,-7.693299936880303;108.79348754882811,-7.6973827067235465',
        'kodekab':'32.18'
    },
    'KOTA BANJAR':{
        'polygon':'108.62594604492188,-7.339312794263156;108.60980987548828,-7.3399938135803655;108.59058380126952,-7.342377372978888;108.577880859375,-7.331821512983473;108.56586456298828,-7.3250111479085485;108.54801177978516,-7.321946449669454;108.5452651977539,-7.330459448297857;108.53084564208984,-7.343058387603264;108.51505279541016,-7.3522519828994035;108.49685668945311,-7.3410153406011425;108.47763061523438,-7.347484957231748;108.46492767333984,-7.3648503043045865;108.46355438232422,-7.377788748190241;108.4848403930664,-7.395493374019949;108.5013198852539,-7.4057072583396195;108.5232925415039,-7.413197289782785;108.5397720336914,-7.419665850784938;108.54869842529297,-7.425793873484563;108.55899810791016,-7.440432692915833;108.58028411865234,-7.434985747344793;108.58165740966797,-7.424772542298222;108.59127044677733,-7.41592090600134;108.599853515625,-7.4036645003981;108.61770629882812,-7.411495021091383;108.62560272216797,-7.392769631606526;108.64860534667969,-7.388683986487793;108.6613082885742,-7.376086342962881;108.665771484375,-7.358040445265046;108.66817474365234,-7.345101425217394;108.65718841552734,-7.333524087981666;108.64242553710938,-7.336588706569289;108.62594604492188,-7.339312794263156',
        'kodekab':'32.79'
    },
    'KOTA BEKASI':{
        'polygon':'106.96975708007811,-6.168544986241183;106.95671081542969,-6.2037013182340495;106.94263458251953,-6.225203550938972;106.92752838134766,-6.243974621876448;106.9021224975586,-6.251482861971768;106.8966293334961,-6.268205372818316;106.90624237060547,-6.2938000139933115;106.9144821166992,-6.312909857433628;106.91207885742188,-6.3408908554681895;106.8966293334961,-6.3838830861560565;106.89353942871094,-6.396165918807985;106.91207885742188,-6.401624860829763;106.92924499511719,-6.3937776133363915;106.95499420166016,-6.353515931008791;106.9625473022461,-6.341914521766597;106.96975708007811,-6.359657747688895;106.99241638183592,-6.368870335103567;106.99722290039062,-6.362046212140628;107.00614929199219,-6.368187926888064;107.01988220214844,-6.357951694857436;107.017822265625,-6.339184740454661;107.02571868896484,-6.3350900413976925;107.04460144042969,-6.299942540436876;107.03567504882812,-6.281173481623201;107.02262878417969,-6.271276796170263;107.04357147216797,-6.252847984958681;107.04666137695312,-6.240903038075121;107.04013824462889,-6.2299817054481945;107.03636169433594,-6.221107955334706;107.03704833984375,-6.205749187759942;107.02949523925781,-6.194485806945051;107.01713562011719,-6.1903899724953;107.01095581054688,-6.1903899724953;107.01644897460936,-6.177760949776954;107.01301574707031,-6.170592991992243;106.96975708007811,-6.168544986241183',
        'kodekab':'32.75'
    },
    'KOTA BOGOR':{
        'polygon':'106.76204681396484,-6.516249088211123;106.76101684570312,-6.523753337431936;106.7596435546875,-6.541149119044767;106.7544937133789,-6.543877814194798;106.74694061279297,-6.542513468482779;106.73973083496094,-6.536373866680462;106.73458099365234,-6.546265410222856;106.72908782958984,-6.562637189489032;106.73526763916014,-6.572528212089444;106.74522399902344,-6.579349492380773;106.75209045410156,-6.580713737202277;106.76582336425781,-6.597084382546971;106.78367614746094,-6.624026557936374;106.776123046875,-6.641077807835753;106.76273345947266,-6.650285237221061;106.77852630615234,-6.6611975227129845;106.79328918457031,-6.660174506252598;106.79878234863281,-6.651990297812445;106.8032455444336,-6.659151487659317;106.81320190429686,-6.673814550226924;106.8310546875,-6.685067300513248;106.84925079345703,-6.683362354988123;106.84856414794922,-6.673132557045525;106.85302734374999,-6.655741410281653;106.84856414794922,-6.646193067667017;106.84101104736328,-6.631870206172674;106.83586120605469,-6.620275203820873;106.83586120605469,-6.601518005958165;106.8416976928711,-6.5803726763481905;106.83483123779297,-6.552745970448975;106.82624816894531,-6.53978476588151;106.8207550048828,-6.534668408354442;106.80667877197266,-6.536714957647734;106.79672241210938,-6.538761498564833;106.79431915283203,-6.5261410295289535;106.78951263427733,-6.515225772797997;106.7812728881836,-6.5080625064802025;106.76925659179688,-6.51079138189219;106.76204681396484,-6.516249088211123',
        'kodekab':'32.71'
    },
    'KOTA CIREBON':{
        'polygon':'108.55831146240234,-6.690352593844872;108.5529899597168,-6.691546039264504;108.54183197021484,-6.693421447602571;108.54148864746094,-6.701093497583645;108.54732513427734,-6.712004649623867;108.54286193847656,-6.721040262325412;108.5310173034668,-6.725984205760005;108.51591110229492,-6.733144310496031;108.51882934570312,-6.745077583589011;108.52603912353516,-6.7559877474853325;108.5320472717285,-6.765022540689777;108.52689743041992,-6.777636874864593;108.53015899658203,-6.784796215043503;108.53771209716797,-6.7912736215944705;108.54698181152344,-6.798603213304989;108.55127334594727,-6.792807731428893;108.55573654174803,-6.789228134206112;108.55607986450194,-6.775761792005727;108.55865478515625,-6.767238596240642;108.56277465820312,-6.7599085275423;108.56843948364258,-6.753771640348936;108.58251571655273,-6.752237406384869;108.5969352722168,-6.7508736387777715;108.59659194946289,-6.744225216681574;108.59024047851562,-6.735360511987079;108.58234405517578,-6.723938442162671;108.57856750488281,-6.720017371198942;108.57667922973633,-6.713709495051198;108.57135772705078,-6.701945940133476;108.56311798095703,-6.68898865265184;108.55831146240234,-6.690352593844872',
        'kodekab':'32.74'
    },
    'KOTA TASIKMALAYA':{
        'polygon':'108.2046890258789,-7.278016797797649;108.20228576660156,-7.27529233637217;108.19301605224608,-7.267118852885314;108.17722320556639,-7.268481110463124;108.16864013671875,-7.280400687972943;108.15799713134766,-7.279038466566971;108.14666748046874,-7.284146775502473;108.15559387207031,-7.313433288513156;108.14666748046874,-7.323649062403275;108.15216064453125,-7.3399938135803655;108.15902709960938,-7.355997467167618;108.16417694091797,-7.39004587239284;108.1765365600586,-7.406047717076258;108.18099975585938,-7.442475280073104;108.19061279296875,-7.4533689175315585;108.20606231689453,-7.4506455335541295;108.21395874023438,-7.442815710341247;108.22803497314453,-7.43600705478823;108.24176788330078,-7.434645311002363;108.26717376708984,-7.438730529686968;108.27266693115234,-7.429198293633241;108.27987670898438,-7.415580454895462;108.2809066772461,-7.397536169801202;108.27953338623045,-7.378810188182938;108.28022003173828,-7.373021997053359;108.29601287841797,-7.3651907945112365;108.29601287841797,-7.354294978235896;108.2925796508789,-7.348506467038435;108.31558227539062,-7.339312794263156;108.30940246582031,-7.333183573502867;108.28502655029297,-7.329437897050044;108.27781677246094,-7.318200678773189;108.2589340209961,-7.314454876427281;108.24073791503905,-7.306282107675563;108.21979522705078,-7.288914477987305;108.2046890258789,-7.278016797797649',
        'kodekab':'32.78'
    },
    'KAB. BOGOR':{
        'polygon':'106.95877075195312,-6.2920937437552285;106.94366455078125,-6.331677767365065;106.92855834960938,-6.364434665490979;106.88186645507812,-6.413566092994113;106.85714721679688,-6.440859286647739;106.81869506835938,-6.429942184960368;106.76376342773438,-6.414930787438788;106.74453735351562,-6.37125875671309;106.70608520507812,-6.3425969648362726;106.62368774414062,-6.338502292868852;106.57974243164061,-6.320758338986847;106.50146484374999,-6.309838680093361;106.468505859375,-6.28663364135058;106.43829345703125,-6.30847370654308;106.41082763671875,-6.341232077793491;106.43142700195311,-6.394459987466794;106.4190673828125,-6.43676540101216;106.3861083984375,-6.47360918121307;106.39022827148438,-6.566388979822327;106.40945434570312,-6.67006357597727;106.47537231445312,-6.762806474971467;106.57012939453125,-6.7614427371695;106.64154052734374,-6.768261387680106;106.73492431640624,-6.746441367521438;106.8475341796875,-6.8118984663854905;106.99859619140625,-6.7614427371695;107.0013427734375,-6.734167173980427;107.01644897460936,-6.6809754212657575;107.03979492187499,-6.67961145390872;107.22518920898438,-6.648239156702318;107.23480224609374,-6.5895812371657;107.20321655273436,-6.554110288191667;107.19635009765625,-6.526823225180405;107.19223022460938,-6.488618840362261;107.17300415039062,-6.4613282190854;107.08648681640624,-6.428577530758005;107.07550048828125,-6.402648405963884;107.05352783203125,-6.380812331938274;107.03842163085938,-6.401283678662477;107.01095581054688,-6.379447546377781;106.99722290039062,-6.339867187137434;106.98898315429688,-6.307108729397881;106.95877075195312,-6.2920937437552285',
        'kodekab':'32.01'
    },
    'KAB. BANDUNG':{
        'polygon':'107.64129638671875,-6.961870493881151;107.6275634765625,-6.960507326113321;107.60696411132812,-6.960507326113321;107.57537841796875,-6.955054615454706;107.55477905273436,-6.905977376721612;107.52319335937499,-6.916883871079278;107.51220703125,-6.948238638117006;107.479248046875,-6.972775693390861;107.46139526367188,-7.012304910822604;107.42706298828125,-7.034112699606202;107.38311767578124,-7.083176475142739;107.28424072265625,-7.132235030578753;107.24990844726561,-7.1690255001643335;107.24029541015625,-7.209900314368781;107.28424072265625,-7.209900314368781;107.33642578124999,-7.234423433691026;107.42980957031249,-7.278016797797649;107.53005981445311,-7.271205613225013;107.56439208984375,-7.2902766693783825;107.65777587890625,-7.325692189100314;107.7374267578125,-7.314795405212431;107.75802612304688,-7.279379022306316;107.73193359375,-7.231698708367139;107.74978637695312,-7.196275785130191;107.77862548828125,-7.193550830168335;107.82257080078125,-7.147224098111096;107.84866333007812,-7.098167144769035;107.88299560546875,-7.081813662812581;107.95028686523438,-7.045016210142384;107.92282104492188,-7.031386781951739;107.90359497070312,-6.990496101016948;107.93655395507811,-6.974138825489063;107.91595458984375,-6.940059334882694;107.89260864257812,-6.948238638117006;107.85140991210938,-6.960507326113321;107.81158447265624,-6.956417799055935;107.77313232421875,-6.942785785094588;107.76489257812499,-6.905977376721612;107.742919921875,-6.859621975047301;107.75665283203124,-6.818716401984169;107.7374267578125,-6.798262304540396;107.70172119140624,-6.820079977465802;107.677001953125,-6.821443549066319;107.6495361328125,-6.825534240573385;107.61520385742188,-6.8555315754820265;107.63031005859375,-6.893707270014225;107.67150878906249,-6.904614047238073;107.72369384765625,-6.907340702276085;107.720947265625,-6.929153376172381;107.6934814453125,-6.964596817535289;107.64129638671875,-6.961870493881151',
        'kodekab':'32.04'
    },
    'KAB. CIAMIS':{
        'polygon':'108.25653076171875,-7.050467869276467;108.2208251953125,-7.045016210142384;108.18511962890624,-7.045016210142384;108.16314697265625,-7.060008118360907;108.18923950195312,-7.096804376787044;108.18099975585938,-7.154037148145602;108.17001342773436,-7.215350011351342;108.18511962890624,-7.276654569152671;108.23455810546875,-7.321605926342506;108.3636474609375,-7.370638602239241;108.38150024414062,-7.382895924568794;108.38150024414062,-7.446900852944821;108.40072631835938,-7.5068118931644365;108.58062744140625,-7.5830503620733385;108.63967895507812,-7.568076010017119;108.67263793945312,-7.524511305631092;108.67950439453125,-7.493196470122275;108.71795654296875,-7.504088842638866;108.73306274414062,-7.476857400769451;108.73031616210938,-7.427836528738325;108.70697021484375,-7.386981623203413;108.66989135742188,-7.347484957231748;108.63555908203125,-7.362466865535738;108.599853515625,-7.367914706747756;108.57925415039062,-7.412856836570883;108.533935546875,-7.410133201401413;108.48724365234375,-7.384257828309248;108.50234985351562,-7.373362480979622;108.55178833007811,-7.3651907945112365;108.577880859375,-7.332502543763999;108.58200073242188,-7.283465671007045;108.58749389648438,-7.239872834988181;108.58200073242188,-7.194913309694296;108.54904174804688,-7.1744756877726825;108.52844238281249,-7.148586716248072;108.50509643554686,-7.1267843388585685;108.47625732421875,-7.111794602472421;108.45016479492186,-7.103618176327366;108.42269897460938,-7.081813662812581;108.39248657226562,-7.057282352971569;108.34304809570312,-7.047742047725658;108.25653076171875,-7.050467869276467',
        'kodekab':'32.07'
    },
    'KAB. INDRAMAYU':{
        'polygon':'108.20571899414062,-6.215647111556399;108.18374633789062,-6.223838355951414;108.18374633789062,-6.256602054794918;108.15902709960938,-6.279808432740426;108.10958862304688,-6.298918791076363;108.07662963867186,-6.296188782911225;108.00247192382812,-6.267522831839373;107.93655395507811,-6.227933930268672;107.90634155273438,-6.238855305536241;107.91046142578125,-6.267522831839373;107.90084838867188,-6.32621808201486;107.8857421875,-6.373988367796561;107.86102294921875,-6.41902484884234;107.874755859375,-6.47633824336597;107.88986206054686,-6.528187613695323;107.82394409179688,-6.571846078912394;107.85690307617188,-6.593673875998463;107.91595458984375,-6.633234306169566;107.98324584960936,-6.678247482748998;108.04367065429688,-6.67961145390872;108.06564331054688,-6.642782900356179;108.08486938476561,-6.593673875998463;108.1109619140625,-6.560931820902541;108.1439208984375,-6.607315761274951;108.18374633789062,-6.622321400509707;108.21807861328125,-6.596402283115148;108.24966430664062,-6.627777883529181;108.32244873046875,-6.627777883529181;108.35678100585936,-6.593673875998463;108.39660644531249,-6.5595675218299085;108.424072265625,-6.547288662168586;108.424072265625,-6.5909454538633145;108.5009765625,-6.577303118123875;108.54629516601562,-6.532280756929124;108.55728149414062,-6.492712306196848;108.5394287109375,-6.468151012664202;108.48587036132812,-6.423118877334097;108.44192504882812,-6.391730485481462;108.40484619140625,-6.353515931008791;108.39660644531249,-6.311203650047962;108.37326049804686,-6.247046187661611;108.34579467773438,-6.225203550938972;108.2977294921875,-6.233394646324949;108.26614379882812,-6.222473157416403;108.20571899414062,-6.215647111556399',
        'kodekab':'32.12'
    },
    'KAB. BEKASI':{
        'polygon':'106.99859619140625,-5.9179467186025105;106.97113037109375,-5.964387815824366;106.97250366210938,-6.058623804918194;106.9573974609375,-6.084569967945614;106.962890625,-6.156939470946354;106.98623657226562,-6.1856114588332645;107.0123291015625,-6.232029472638188;107.02194213867188,-6.301648784883256;106.97799682617188,-6.3425969648362726;106.98486328124999,-6.379447546377781;107.02194213867188,-6.420389528664134;107.07000732421875,-6.450411558010167;107.12356567382812,-6.474973714133618;107.16476440429686,-6.474973714133618;107.215576171875,-6.477702768909363;107.22381591796875,-6.4517761535131415;107.2320556640625,-6.394459987466794;107.22518920898438,-6.343961848265028;107.24441528320312,-6.307108729397881;107.29522705078125,-6.257967164413909;107.32131958007812,-6.215647111556399;107.31033325195312,-6.165131625741878;107.28424072265625,-6.117342277802711;107.25128173828125,-6.085935520826552;107.20046997070312,-6.065451863686615;107.14004516601562,-6.03131070712581;107.10845947265625,-6.001264710802936;107.10708618164062,-5.9753145624398805;107.10708618164062,-5.935704071135596;107.07000732421875,-5.9070188333813585;107.02606201171875,-5.9029208208054245;106.99859619140625,-5.9179467186025105',
        'kodekab':'32.16'
    },
    'KOTA BANDUNG':{
        'polygon':'107.54104614257812,-6.930175820524834;107.55237579345703,-6.949261041019529;107.57469177246094,-6.963233657688719;107.60009765625,-6.965619184820332;107.61554718017578,-6.962211285204347;107.62516021728516,-6.966641549876569;107.65022277832031,-6.966641549876569;107.67219543457031,-6.9731164767872755;107.69691467285156,-6.9731164767872755;107.7106475830078,-6.967663912703658;107.71991729736328,-6.960166533552673;107.71820068359374,-6.949261041019529;107.73021697998047,-6.927108480815676;107.73124694824219,-6.917224694971838;107.73639678955078,-6.911430655357397;107.7432632446289,-6.900183199290568;107.73502349853516,-6.893025588098955;107.72472381591797,-6.892684746773636;107.71820068359374,-6.8974565030182164;107.71648406982422,-6.88791294248871;107.70996093749999,-6.882800241767556;107.6993179321289,-6.888594631755133;107.698974609375,-6.8981381785581535;107.69828796386719,-6.903250713826217;107.69073486328125,-6.894048110604163;107.68146514892578,-6.886549561016701;107.67631530761719,-6.886549561016701;107.67013549804688,-6.8817776950135325;107.66258239746094,-6.881095995953889;107.65674591064453,-6.885867868811319;107.64850616455078,-6.886890406752077;107.63614654541016,-6.8787100415377065;107.63202667236327,-6.865757508522104;107.62928009033203,-6.859962840092346;107.63408660888672,-6.853145492854402;107.62653350830078,-6.847691544866724;107.62104034423828,-6.844282795711849;107.6107406616211,-6.844964547490535;107.60490417480469,-6.846328048126528;107.60009765625,-6.836783461905541;107.5949478149414,-6.834056402245376;107.58602142333984,-6.842578412005578;107.5832748413086,-6.855190707266554;107.57366180419922,-6.86200802523898;107.56576538085938,-6.874960660382537;107.56782531738281,-6.884504481462231;107.55889892578125,-6.885186175626453;107.55271911621094,-6.885186175626453;107.55271911621094,-6.8933664291791565;107.56130218505858,-6.908022363579669;107.56027221679688,-6.916202222556309;107.5564956665039,-6.923359482967472;107.54791259765625,-6.920973741554143;107.54207611083984,-6.924041121155891;107.54104614257812,-6.930175820524834',
        'kodekab':'32.73'
    },
    'KOTA CIMAHI':{
        'polygon':'107.54310607910156,-6.832181539705098;107.54430770874023,-6.829965783589971;107.53400802612303,-6.831158884312092;107.5338363647461,-6.839510506003849;107.52920150756836,-6.846328048126528;107.53143310546875,-6.8524637527670915;107.5312614440918,-6.858599378448515;107.52199172973633,-6.863030614517987;107.5173568725586,-6.871552106388241;107.51495361328124,-6.883652362379861;107.51049041748047,-6.889276320041728;107.50722885131836,-6.898819853116928;107.51375198364258,-6.907681533050691;107.51718521118164,-6.916202222556309;107.52559661865234,-6.923870711701105;107.5312614440918,-6.920121688126844;107.53950119018555,-6.921144152055039;107.54344940185547,-6.9277901135865925;107.55838394165038,-6.93358395234781;107.56507873535156,-6.934095169995226;107.5667953491211,-6.930005413286767;107.56662368774414,-6.923700302184781;107.56954193115233,-6.908533608912567;107.5645637512207,-6.897797340910827;107.5590705871582,-6.890639693674967;107.57778167724608,-6.892003063387702;107.57692337036133,-6.888594631755133;107.57400512695312,-6.882629817461513;107.57143020629883,-6.877687485975581;107.56799697875977,-6.874449378841697;107.56559371948241,-6.871381678046965;107.5697135925293,-6.864734925101462;107.5667953491211,-6.857235912902055;107.56061553955078,-6.853486362532471;107.55701065063477,-6.84803241844297;107.55769729614256,-6.842748850649993;107.55151748657227,-6.837976545613755;107.55134582519531,-6.8332041929111424;107.54722595214844,-6.830647555795591;107.54310607910156,-6.832181539705098',
        'kodekab':'32.77'
    },
    'KOTA DEPOK':{
        'polygon':'106.77921295166016,-6.310862407896444;106.776123046875,-6.317004732222922;106.76891326904297,-6.3425969648362726;106.75758361816406,-6.351127426942715;106.74213409423828,-6.352492287766378;106.72428131103516,-6.356245636365608;106.71501159667969,-6.357951694857436;106.7105484008789,-6.3654582849560235;106.71844482421875,-6.380129939612401;106.72325134277344,-6.414248440673229;106.74179077148438,-6.442906217083629;106.75724029541016,-6.442223907855765;106.78092956542969,-6.442906217083629;106.79122924804688,-6.452458449886488;106.80015563964844,-6.449388108971545;106.81148529052734,-6.449046958832748;106.81732177734375,-6.4661041842577065;106.82659149169922,-6.462010502585489;106.83895111083984,-6.4521173018146705;106.84444427490233,-6.443247371353482;106.85268402099608,-6.459281363064719;106.87877655029297,-6.460645934665188;106.88495635986328,-6.453823039876365;106.88838958740234,-6.443247371353482;106.89559936523438,-6.432671482375361;106.90452575683594,-6.423118877334097;106.91722869873047,-6.417660165363658;106.92031860351562,-6.407424922788262;106.92272186279295,-6.395483546954681;106.90624237060547,-6.3886597783369705;106.91585540771484,-6.375694367347368;106.91963195800781,-6.362387420441884;106.90589904785156,-6.357269272139876;106.89319610595703,-6.367846722440139;106.88461303710938,-6.364093458549334;106.87534332275389,-6.356586848516734;106.864013671875,-6.350103778950092;106.86298370361328,-6.345326728078956;106.85474395751953,-6.334066361556318;106.84513092041014,-6.3350900413976925;106.83345794677734,-6.3408908554681895;106.82487487792969,-6.35215107289977;106.8207550048828,-6.348738911794008;106.8094253540039,-6.35215107289977;106.80015563964844,-6.3606813766701595;106.79466247558594,-6.359657747688895;106.79534912109375,-6.348056476859352;106.80839538574219,-6.330654080757582;106.8094253540039,-6.311886133676643;106.8039321899414,-6.311203650047962;106.77921295166016,-6.310862407896444',
        'kodekab':'32.76'
    },
    'KOTA SUKABUMI':{
        'polygon':'106.9325065612793,-6.900183199290568;106.93164825439453,-6.898308597289842;106.92392349243164,-6.896433987868805;106.91688537597656,-6.890298850634183;106.90898895263672,-6.891321379021458;106.90727233886717,-6.905636544719058;106.89920425415039,-6.9110898272853465;106.90658569335936,-6.947727435831962;106.90349578857422,-6.952498635539128;106.89268112182617,-6.9545434205841845;106.88117980957031,-6.95624740132218;106.8801498413086,-6.956928991886221;106.86830520629883,-6.968856666517464;106.87242507934569,-6.977035468024809;106.8885612487793,-6.975501953620171;106.90435409545898,-6.981124815211191;106.93216323852539,-6.967834306291433;106.94332122802734,-6.9737980428364015;106.95104598999023,-6.967323125342339;106.9570541381836,-6.9613593064322625;106.95928573608398,-6.949090640690187;106.9625473022461,-6.940229738483669;106.96151733398436,-6.928982968564734;106.96186065673827,-6.920973741554143;106.9573974609375,-6.917906342019082;106.95825576782225,-6.915179747927456;106.95671081542969,-6.910237756030072;106.95533752441406,-6.903761964315963;106.94847106933594,-6.9015465415383614;106.93971633911133,-6.903080296873566;106.9325065612793,-6.900183199290568',
        'kodekab':'32.72'
    },
}

def GetConnectionFromFile():
    file = open('Connection', 'r')
    conn = {}
    for each in file.readlines():
        conn[each.split(':')[0]] = each.split(':')[1].replace('\n', '')
    return conn

def GetJSON(address, kab, kode, pol):
    api=address+pol
    info=requests.get(api).json()
    
    # data=[]
    itemRoot={}
    itemRoot['created_time']=str(datetime.datetime.utcnow())[0:19]
    itemRoot['kode_kabupaten']=PolygonKabupaten[kab].get('kodekab')
    itemRoot['kabupaten']=kab

    for key, value in info.items():
        if not isinstance(value, dict) and not isinstance(value, list):
            itemRoot[key]=value

    #alerts
    alerts=[]
    if info.get('alerts'):
        for element in info['alerts']:
            item=itemRoot.copy()
            item['category']='alerts'
            for k1, v1 in element.items():
                if not isinstance(v1, dict) and not isinstance(v1, list):
                    item[k1]=v1
                elif isinstance(v1, dict):
                    for k2, v2 in v1.items():
                        item[k1+'_'+k2]=json.dumps(v2)
            alerts.append(item)

    #irregularities
    irregularities=[]
    if info.get('irregularities'):
        for element in info['irregularities']:
            item=itemRoot.copy()
            item['category']='irregularities'
            for k1, v1 in element.items():
                if not isinstance(v1, dict) and not isinstance(v1, list):
                    item[k1]=v1
                elif k1=='line':
                    item[k1]=json.dumps(v1)
            for element1 in element.get('alerts'):
                item1=item.copy()
                for k2, v2 in element1.items():
                    if not isinstance(v2, dict) and not isinstance(v2, list):
                        item1[k2]=v2
                    elif isinstance(v2, dict):
                        for k3, v3 in v2.items():
                            item1['alerts_'+k2+'_'+k3]=json.dumps(v3)
                irregularities.append(item1)

    #jams
    jams=[]
    if info.get('jams'):
        for element in info['jams']:
            item=itemRoot.copy()
            item['category']='jams'
            for k1, v1 in element.items():
                if not isinstance(v1, dict) and not isinstance(v1, list):
                    item[k1]=v1
                elif k1=='line' or k1=='segments':
                    item[k1]=json.dumps(v1)
            jams.append(item)
    
    data1=alerts+irregularities+jams
    data2=[{
        'kode_kota_kabupaten':kode,
        'nama_kota_kabupaten':kab,
        'created_time':str(datetime.datetime.utcnow())[0:19],
        'start_time':info.get('startTime'),
        'endTime':info.get('endTime'),
        'total_alerts':len(alerts),
        'total_irregularities':len(irregularities),
        'total_jams':len(jams),
        'total':len(data1)
    }]

    #push data into database
    dfStructured=pd.DataFrame(data1)
    dfStructured=dfStructured.applymap(lambda x: x.upper().strip().encode('ascii', 'ignore').decode('utf-8') if isinstance(x, str) else x)
    dfStructured.to_sql(name='waze_table_structured', con=engine, schema='test', if_exists='append', index=False)

    dfRecap=pd.DataFrame(data2)
    dfRecap.to_sql(name='waze_table_recap', con=engine, schema='test', if_exists='append', index=False)
    print(kab+': '+'%d rows of data has been added to database'%(len(dfStructured)))
    # df.to_excel('test.xlsx', index=False)


#main
if __name__=='__main__':
    conn=GetConnectionFromFile()
    engine=create_engine('postgresql+psycopg2://%s:%s@%s:%s/%s' % (conn['username'], conn['password'], conn['host'], conn['port'], conn['database']))
    address=conn['url']

    threads=[]
    for kab, attr in PolygonKabupaten.items():
        t=threading.Thread(target=GetJSON, args=(address, kab, attr['kodekab'], attr['polygon']))
        threads.append(t)
        
    for t in threads:
        t.start()
        
    for t in threads:
        t.join()